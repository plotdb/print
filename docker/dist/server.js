// Generated by LiveScript 1.6.0
(function(){
  var express, jsonwebtoken, print, APIKEY, printer, app, port;
  express = require('express');
  jsonwebtoken = require('jsonwebtoken');
  print = require("./index");
  APIKEY = (process.env.APIKEY || 'api-key-not-given').trim();
  printer = new print();
  process.on('SIGINT', function(){
    return process.exit();
  });
  app = express();
  app.use(express.json());
  app.get('/ping', function(req, res){
    return res.send({
      text: "pong"
    });
  });
  app.post('/pdf', function(req, res){
    var token, payload, e, logText;
    try {
      if (!(token = req.body.token)) {
        throw new Error();
      }
      payload = jsonwebtoken.verify(token, APIKEY);
      if (!(payload.url || payload.html)) {
        throw new Error();
      }
    } catch (e$) {
      e = e$;
      console.log("[payload verify failed] ", e.toString());
      return res.status(404).send();
    }
    logText = payload.url
      ? "url: " + payload.url
      : payload.html ? "html: " + (payload.html + '').length + "bytes" : "(payload: no content)";
    console.log(("[" + (payload.timestamp || 'no-timestamp') + "] ") + logText);
    return printer.init().then(function(){
      return printer.print({
        url: payload.url,
        html: payload.html
      });
    }).then(function(it){
      return res.send(it);
    })['catch'](function(e){
      return console.log("[print failed] ", e.toString());
    });
  });
  port = process.env.PORT || 8080;
  app.listen(port);
}).call(this);
